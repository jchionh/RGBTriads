<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico">
    <!-- get the css in -->
    <link rel="stylesheet" type="text/css" href="css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="css/rgb_triads.css" />

    <script type="text/javascript">
        // When the window has loaded, DOM is ready. init our main app
        function init() {
            mainInit();
        }
        window.onload = init;
    </script>

    <!-- just define the shaders here for now... ideally these need to be in separate files -->
    <script id="vtxShader" type="x-shader/x-vertex">
        // here's the calculated model-view-projection matrix
        uniform mat4 u_MVPMatrix;
        // here's the texture transform matrix
        uniform mat4 u_TexMatrix;
        // here's the image texture transform matrix
        uniform mat4 u_ImageTexMatrix;

        // per-vertex position
        attribute vec3 a_Position;
        // per-vertex color
        attribute vec4 a_Color;
        // texture coordinate
        attribute vec2 a_TexCoord;

        // tex coord to pass to the frag shader
        varying vec2 v_TexCoord;
        varying vec2 v_ImageTexCoord;
        // color passed to the frag shader
        varying vec4 v_Color;

        // main program
        void main()
        {
            // vertex color passed into the varying (to be interpolated per fragment)
            v_Color = a_Color;

            // transform our vertex coords here
            vec4 texTransformed = u_TexMatrix * vec4(a_TexCoord.x, a_TexCoord.y, 0.0, 1.0);
            v_TexCoord = texTransformed.xy;

            vec4 texImageTransformed = u_ImageTexMatrix * vec4(a_TexCoord.x, a_TexCoord.y, 0.0, 1.0);
            v_ImageTexCoord = texImageTransformed.xy;

            // transform our vertex here
            gl_Position = u_MVPMatrix * vec4(a_Position, 1.0);
        }
    </script>

    <script id="fragShader" type="x-shader/x-fragment">
        // set medium precision on the frag shader
        precision mediump float;

        // here's the input shader
        uniform sampler2D u_Texture;
        uniform sampler2D u_ImageTexture;
        uniform bool u_doVignette;
        uniform float u_vigOuterBorder;
        uniform float u_vigFade;
        uniform float u_fStop;
        uniform float u_texCenterU;
        uniform float u_texCenterV;
        uniform float u_imageBrightness;

        uniform float u_rBrightness;
        uniform float u_gBrightness;
        uniform float u_bBrightness;

        // here's the interpolated vertex color for this fragment
        varying vec4 v_Color;
        // and the interpolated tex coord
        varying vec2 v_TexCoord;
        varying vec2 v_ImageTexCoord;

        // user vars
        float vigInnerBorder = 0.0;

        float vignette()
        {
            if (!u_doVignette) {
                return 1.0;
            }
            float dist = distance(v_TexCoord.xy, vec2(u_texCenterU, u_texCenterV));
            dist = smoothstep(u_vigOuterBorder + (u_fStop / u_vigFade), vigInnerBorder + (u_fStop / u_vigFade), dist);
            return clamp(dist, 0.0, 1.0);
        }

        float rgbToLuma(vec3 color)
        {
            return (0.2126 * color.r) + (0.7152 * color.g) + (0.0722 * color.b);
        }

        // main program
        void main()
        {
            // final color is the vertex color with the texture
            vec4 rgbTriad = texture2D(u_Texture, v_TexCoord);
            vec4 image = texture2D(u_ImageTexture, v_ImageTexCoord);
            
            // float luma = rgbToLuma(image.rgb);

            // vec4 texColor = rgbTriad * luma;

            // vec4 texColor = rgbTriad * (luma + image);

            // vec4 texColor = rgbTriad * image;

            //vec4 texColor;
            //texColor.r = rgbTriad.r * pow(image.r, 2.2);
            //texColor.g = rgbTriad.g * pow(image.g, 2.2);
            //texColor.b = rgbTriad.b * pow(image.b, 2.2);

            vec4 texColor;
            texColor.r = u_rBrightness * rgbTriad.r * image.r;
            texColor.g = u_gBrightness * rgbTriad.g * image.g;
            texColor.b = u_bBrightness * rgbTriad.b * image.b;

            gl_FragColor = u_imageBrightness * vignette() * v_Color * texColor;
            // gl_FragColor.rgb = vec3(1.0, 1.0, 1.0);
            gl_FragColor.a = 1.0;
        }
    </script>

    <title>RGB Triads</title>

</head>

<body class="unselectable">

<span>Select state: </span>
<select id="StateSelect" name="StateSelect">
    <option selected="selected" value="RGBTriads">RGB Triads</option>
</select>
<button type="button" onclick="switchState();">Switch to State</button>
<span id="msgArea"></span>
<span style="position: relative">source: <a href="https://github.com/jchionh/RGBTriads">https://github.com/jchionh/RGBTriads</a></span>

<div id="renderArea" style="position: relative; left: 0px; top: 0px;">
    <canvas id="renderCanvas" style="width: 1600px; height: 1200px; position: absolute; left: 0px; top: 0px;"></canvas>
</div>
<div id="controls" style="position: relative; left: 1600px; top: 0px;">
    <!--
    <table>
        
    </table>
    
    -->
    <div>Control Area</div>
    <table>
        <tr>
            <td>&nbsp;</td>
            <td>RGB Triad Scale</td>
            <td>&nbsp;</td>
            <td><input id="rgbTexScale" type="range" min="1.0" max="256.0" step="1.00" value="50.0" oninput="sliderChanged('rgbTexScale');"/></td>
            <td>&nbsp;</td>
            <td><div id="rgbTexScaleText">50</div></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>Image Brightness</td>
            <td>&nbsp;</td>
            <td><input id="imageBrightness" type="range" min="0.1" max="3.0" step="0.001" value="1.236" oninput="sliderChanged('imageBrightness');"/></td>
            <td>&nbsp;</td>
            <td><div id="imageBrightnessText">1.236</div></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>Red</td>
            <td>&nbsp;</td>
            <td><input id="rBrightness" type="range" min="0.1" max="3.0" step="0.001" value="1.0" oninput="sliderChanged('rBrightness');"/></td>
            <td>&nbsp;</td>
            <td><div id="rBrightnessText">1.0</div></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>Green</td>
            <td>&nbsp;</td>
            <td><input id="gBrightness" type="range" min="0.1" max="3.0" step="0.001" value="1.0" oninput="sliderChanged('gBrightness');"/></td>
            <td>&nbsp;</td>
            <td><div id="gBrightnessText">1.0</div></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>Blue</td>
            <td>&nbsp;</td>
            <td><input id="bBrightness" type="range" min="0.1" max="3.0" step="0.001" value="1.0" oninput="sliderChanged('bBrightness');"/></td>
            <td>&nbsp;</td>
            <td><div id="bBrightnessText">1.0</div></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>Vignette</td>
            <td>&nbsp;</td>
            <td><input id="doVignette" type="checkbox" onchange="vignetteOnOff();"/></td>
            <td>&nbsp;</td>
            <td><div id="doVignetteText">Off</div></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>Border</td>
            <td>&nbsp;</td>
            <td><input id="vigOuterBorder" type="range" min="0.01" max="100.0" step="0.01" value="40.0" oninput="sliderChanged('vigOuterBorder');"/></td>
            <td>&nbsp;</td>
            <td><div id="vigOuterBorderText">40.0</div></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>Fade</td>
            <td>&nbsp;</td>
            <td><input id="vigFade" type="range" min="10" max="200" step="1" value="70" oninput="sliderChanged('vigFade');"/></td>
            <td>&nbsp;</td>
            <td><div id="vigFadeText">70</div></td>
        </tr>
        <tr>
            <td>&nbsp;</td>
            <td>F-Stop</td>
            <td>&nbsp;</td>
            <td><input id="fStop" type="range" min="0.01" max="10.0" step="0.01" value="8.0" oninput="sliderChanged('fStop');"/></td>
            <td>&nbsp;</td>
            <td><div id="fStopText">8.0</div></td>
        </tr>
    </table>
    <button onclick="defaultVignetteValues();">Default Vignette Values</button>
</div>
<!--
<div id="sysMessageArea" style="position: relative;">
</div>
-->

<!-- js sources -->
<script src="js/webgl_app01.js"></script>

<!-- utils -->
<script src="js/utils/extend.js"></script>
<script src="js/utils/webgl-utils.js"></script>
<script src="js/utils/ShaderUtils.js"></script>
<script src="js/utils/IntrusiveList.js"></script>
<script src="js/utils/IntrusiveListNode.js"></script>
<script src="js/utils/glMatrix.js"></script>
<script src="js/utils/ImageUtils.js"></script>
<script src="js/render/RenderConstants.js"></script>

<!-- texture -->
<script src="js/texture/Texture.js"></script>

<!-- cache -->
<script src="js/cache/QuadVertexBufferLibrary.js"></script>
<script src="js/cache/QuadVertexColorBufferLibrary.js"></script>
<script src="js/cache/QuadTexCoordBufferLibrary.js"></script>
<script src="js/cache/TextureLibrary.js"></script>

<!-- renderer -->
<script src="js/render/Viewpoint.js"></script>
<script src="js/render/FrustumViewpoint.js"></script>
<script src="js/render/Shape.js"></script>
<script src="js/render/QuadShape.js"></script>
<script src="js/render/SceneNode.js"></script>
<script src="js/render/Scene.js"></script>
<script src="js/render/ShaderHandleRefs.js"></script>
<script src="js/render/Renderer.js"></script>

<!-- entity -->
<script src="js/entity/Entity.js"></script>
<script src="js/entity/ImageEntityGlobals.js"></script>
<script src="js/entity/ImageEntity.js"></script>
<script src="js/entity/RGBTriadImageEntity.js"></script>
<script src="js/entity/ImageEntityFactory.js"></script>

<!-- input -->
<script src="js/input/MouseInput.js"></script>
<script src="js/input/InputManager.js"></script>

<!-- run states -->
<script src="js/runstate/BaseRunState.js"></script>
<script src="js/runstate/GLRunState.js"></script>
<script src="js/runstate/StateRunner.js"></script>

<!-- app run states -->
<script src="js/states/InitialState.js"></script>
<script src="js/states/RGBTriads.js"></script>

<!-- main -->
<script src="js/main.js"></script>

</body>
</html>